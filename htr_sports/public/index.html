<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <script type="module" src="message.js"></script>
  <meta
  name="description"
  content="Web site created using create-react-app"
  />
  <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
  <!--
  manifest.json provides metadata used when your web app is installed on a
  user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
-->
<link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
<!--
Notice the use of %PUBLIC_URL% in the tags above.
It will be replaced with the URL of the `public` folder during the build.
Only files inside the `public` folder can be referenced from the HTML.

Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
work correctly both with client-side routing and a non-root public URL.
Learn how to configure a non-root public URL by running `npm run build`.
-->
<title>Hunter Sports</title>
</head>

<body>

  <ul>
    <li><a href="#huntersports">Hunter Sports</a></li>
    <li><a href="soccer.html">Soccer</a></li>
    <li><a href="basketball.html">Basketball</a></li>
    <li><a href="fantasy.html">Fantasy</a></li>
    <li><a href="forum.html">Forum</a></li>
    <li><a href="findgame.html">Find a Game</a></li>
    <li><a href="#search">Search</a></li>
  </ul>
  <div id = "profilePicture"></div>
  <div id = "uploadPhotoSpot"></div>
  <div class = "dropdown" id = "signIn">
    <button class = "dropbtn">Create Account</button>
    <div class = "dropdown-content">
      <form autocomplete="off">
        <label for = "email">Username:</label>
        <input type = "text" id = "email" name = "email"><br><br>
        <label for = "password">Password:</label>
        <input type = "password" id = "password" name = "password"><br><br>
        <input type = "button" id = "insert" value = "Enter"> <!-- onclick = "createAccount()" -->
      </form>
    </div>
  </div>

  <h4>V 2.2</h4>
  <!--Disabled for Haley to use only

  <div id = "Test">Bruh</div>
  <input type="button" value="click" onclick="displayAPI()"/>
-->
</body>

<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.4/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.4/firebase-analytics.js";
import { getDatabase, set, get, update, remove, ref, child } from "https://www.gstatic.com/firebasejs/9.9.4/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/9.9.4/firebase-auth.js";
import { getStorage, ref as storageref, uploadBytes, getDownloadURL, deleteObject }  from "https://www.gstatic.com/firebasejs/9.9.4/firebase-storage.js";

// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBoF3DW_pIDocCRPlrqFpUfxdXtCT7lpFQ",
  authDomain: "htr-sports.firebaseapp.com",
  databaseURL: "https://htr-sports-default-rtdb.firebaseio.com",
  projectId: "htr-sports",
  storageBucket: "htr-sports.appspot.com",
  messagingSenderId: "119767757957",
  appId: "1:119767757957:web:d9f4cfeed391dc8bbde5ec",
  measurementId: "G-WEB0Z72L02"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

const db = getDatabase();

const auth = getAuth(app)

var email = document.getElementById("email");
var password = document.getElementById("password");
var insertBTN = document.getElementById("insert");
var signIn = document.getElementById("signIn")
var profilePicture = document.getElementById("profilePicture")
var uploadPhotoSpot = document.getElementById("uploadPhotoSpot")

function createAccount(){
  //alert("Clicked");
  //const dbref = ref(db)
  createUserWithEmailAndPassword(auth, email.value, password.value)
  .then((userCredential) => {
    // Signed in
    const user = userCredential.user;
    console.log("Just made an account!");

    set(ref(db, 'Users/'+user.uid),{
      DisplayName: "Anonymous",
      Email: email.value,
      Password: password.value,
      ProfilePicture: "None",
      //Email: user.value,
    })
    .then(()=>{
      console.log("Data created")
    })
    .catch((error)=>{
      alert(error);
    });
  })
  .catch((error) => {
    const errorCode = error.code;
    const errorMessage = error.message;
    //alert(errorCode+" : "+errorMessage);
    //console.log(errorCode+":"+errorMessage);
    if (errorCode == "auth/email-already-in-use"){
      console.log('in use');
      signInWithEmailAndPassword(auth, email.value, password.value)
      .then((userCredential) => {
        // Signed in
        const user = userCredential.user;
        console.log("Logged in to existing")
        // ...
      })
      .catch((error) => {
        const nerrorCode = error.code;
        const nerrorMessage = error.message;
        alert(nerrorCode+" : "+nerrorMessage);
        console.log(nerrorCode+":"+nerrorMessage);
      });
    }
  });
}

function updateImage(){
  const user = auth.currentUser;
  if (user){
    const dbref = ref(db)
    get(child(dbref, "Users/" + user.uid))
    .then((snapshot) => {
      if(snapshot.exists()){
        if (profilePicture.hasChildNodes()){
          const image = document.getElementById("pfp");
          image.setAttribute('src',snapshot.val().ProfilePicture);
          if (snapshot.val().ProfilePicture == "None"){
            image.parentNode.removeChild(image)
          }
        }else{
          const image = document.createElement("img");
          image.setAttribute('id','pfp');
          image.setAttribute('alt','Your profile picture');
          image.setAttribute('src',snapshot.val().ProfilePicture);
          profilePicture.appendChild(image);
          if (snapshot.val().ProfilePicture == "None"){
            image.parentNode.removeChild(image)
          }
        }
      }
    })
  }
}

function uploadImage(){
  console.log("Test");
  const user = auth.currentUser;
  if (user){
    const dbref = ref(db)
    console.log(user.uid);
    get(child(dbref, "Users/" + user.uid))
    .then((snapshot)=>{
      if(snapshot.exists()){
        console.log("Found Data")
        const file = document.getElementById("photo").files[0];
        if (file == null){
          const updates = {};
          updates["Users/"+user.uid+"/ProfilePicture"] = "None";
          update(dbref,updates);
          updateImage();
        }else{
          const name = +new Date() + "-" + user.uid + "-" + file.name;
          const storage = getStorage();
          const sref = storageref(storage, name);
          console.log(snapshot.val().ProfilePicture);
          getDownloadURL(storageref(storage,snapshot.val().ProfilePicture))
          .then((url) => {
            deleteObject(storageref(storage,snapshot.val().ProfilePicture))
            .then(() => {
              console.log("Old profile picture deleted");
            })
            .catch((error) => {
              console.log("Error occured deleting");
            });
          })
          .catch(console.error);

          const metadata = {
            contentType: file.type
          };
          const uploadTask = uploadBytes(sref, file, metadata);
          uploadTask
          .then(snapshot => getDownloadURL(snapshot.ref))
          .then(url => {
            console.log(url);
            const updates = {};
            updates["Users/"+user.uid+"/ProfilePicture"] = url;
            update(dbref,updates);
            updateImage();
          })
          .catch(console.error);
        }
      }
    })
  }
}

onAuthStateChanged(auth, (user) => {
  if (user) {
    const uid = user.uid;
    console.log("Signed in!!");
    signIn.parentNode.removeChild(signIn)
    const image_input = document.createElement("input");
    image_input.setAttribute('type','file');
    image_input.setAttribute('id','photo');
    image_input.setAttribute("accept","png")
    image_input.innerHTML = "Upload Image";
    const image_submit = document.createElement("button");
    image_submit.innerHTML = "Submit Image";
    image_submit.onclick = uploadImage;
    uploadPhotoSpot.appendChild(image_input);
    uploadPhotoSpot.appendChild(image_submit);
    updateImage();
  } else {
    console.log("Signed out!");
  }
});

signOut(auth).then(() => {
  // Sign-out successful.
}).catch((error) => {
  // An error happened.
});

insertBTN.addEventListener('click',createAccount);

window.addEventListener('unload',(event)=>{
  auth.signOut();
});

</script>

</html>
